<html>
  <head>
  </head>

  <body>
    <canvas id="canvas" width="640" height="480"></canvas>
    <script type="text/javascript" src="matrix.js"></script>

    <script type="text/javascript">
      var canvas = document.getElementById ("canvas"),
          width = canvas.width,
          width2 = width + width,
          width4 = width2 + width2,
          height = canvas.height,
          height2 = height + height,
          height4 = height2 + height2,
          ctx = canvas.getContext ("2d"),
          id = ctx.getImageData (0, 0, canvas.width, canvas.height),
          data = id.data

      function frame (callback) {
        var i = data.length

        while (i) {
          data[--i] = 0
          i -= 3
        }

        callback ()

        ctx.putImageData (id, 0, 0)
      }

      function plot (points) {
        var i = points.length,
            x, y, z, w, u, v

        while (i) {
          z = points[--i]
          y = points[--i]
          x = points[--i]
          w = x * zx + y * zy + z * zz + zo
          if (w < 1) continue
          w = width4 / w

          u = ((x * xx + y * xy + z * xz + xo) * w + width2) & 0x7ffffffc
          if (u >= width4) continue

          v = ((x * yx + y * yy + z * yz + yo) * w + height2) & 0x7ffffffc
          if (v >= height4) continue

          data[v * width + u + 3] = 255
        }
      }

      function shell (arr, r) {
        var i = arr.length,
            x, y, z, k

        while (i) {
          do {
            x = Math.random () - 0.5
            y = Math.random () - 0.5
            z = Math.random () - 0.5
            k = x * x + y * y + z * z
          } while (k > 0.25)

          k = r / Math.sqrt (k)

          arr[--i] = z * k
          arr[--i] = y * k
          arr[--i] = x * k
        }
      }

      var start = Date.now (),
          twoPi = 2 * Math.PI,
          space = new Float32Array (65536 * 3),
          planet = new Float32Array (8192 * 3)

      shell (space, 65536)
      shell (planet, 1)

      setInterval (function () {
        var millis = Date.now () - start

        frame (function () {
          translate (0, 0, 4, function () {
            rotateY (millis * twoPi / 300000, function () {
              plot (space)

              rotateY (millis * twoPi / 15000, function () {
                plot (planet)
              })
            })
          })
        })
      }, 1000 / 60)
    </script>
  </body>
</html>
