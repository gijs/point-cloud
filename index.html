<html>
  <head>
  </head>

  <body>
    <canvas id="canvas" width="320" height="240" style="background: black; width: 640px; height: 480px;">
    </canvas>

    <script type="text/javascript" src="matrix.js"></script>
    <script type="text/javascript" src="random.js"></script>

    <script type="text/javascript">
      var canvas = document.getElementById ("canvas"),
          width = canvas.width,
          height = canvas.height,
          ctx = canvas.getContext ("2d"),
          id = ctx.getImageData (0, 0, width, height),
          data = id.data,
          w4 = width << 2,
          w2 = width << 1,
          h4 = height << 2,
          h2 = height << 1

      function clear () {
        var i = data.length

        while (i) {
          data[--i] = 0
          i -= 3
        }
      }

      function apply () {
        ctx.putImageData (id, 0, 0)
      }

      function point (x, y, z, rgb) {
        var m = matrix.length - 8,
            u, v, w

        w = x * matrix[m++] + y * matrix[m++] + z * matrix[m++] + matrix[m++]
        if (w < 1) return

        w = w4 / w
        m -= 12

        u = ((x * matrix[m++] + y * matrix[m++] + z * matrix[m++] + matrix[m++]) * w + w2) & 0x7ffffffc
        if (u > w4) return

        v = ((x * matrix[m++] + y * matrix[m++] + z * matrix[m++] + matrix[m++]) * w + h2) & 0x7ffffffc
        if (v > h4) return

        w = v * width + u + 3

        if (data[w]) {
          data[--w] += rgb & 255
          data[--w] += (rgb >> 8) & 255
          data[--w] += (rgb >> 16) & 255
        }

        else {
          data[  w] = 255
          data[--w] = rgb & 255
          data[--w] = (rgb >> 8) & 255
          data[--w] = (rgb >> 16) & 255
        }
      }

      function sphere (ox, oy, oz, or, color) {
        var i = 128,
            x, y, z

        while (i--) {
          do {
            x = random () - 0.5
            y = random () - 0.5
            z = random () - 0.5
          } while (x * x + y * y + z * z > 0.25)

          point (ox + x * or, oy + y * or, ox + z * or, color)
        }
      }

      function line (x1, y1, z1, x2, y2, z2, color) {
        var i = 64,
            t

        x2 -= x1
        y2 -= y1
        z2 -= z1

        while (i--) {
          t = random ()
          point (x1 + x2 * t, y1 + y2 * t, z1 + z2 * t, color)
        }
      }

      function person () {
        var ax =  0.000, ay = 1.000, az = 0,
            bx =  0.000, by = 0.833, bz = 0,
            cx = -0.125, cy = 0.833, cz = 0,
            dx = -0.250, dy = 0.833, dz = 0,
            ex = -0.500, ey = 0.833, ez = 0,
            fx =  0.125, fy = 0.833, fz = 0,
            gx =  0.250, gy = 0.833, gz = 0,
            hx =  0.500, hy = 0.833, hz = 0,
            ix = -0.125, iy = 0.500, iz = 0,
            jx = -0.125, jy = 0.250, jz = 0,
            kx = -0.125, ky = 0.000, kz = 0,
            lx =  0.125, ly = 0.500, lz = 0,
            mx =  0.125, my = 0.250, mz = 0,
            nx =  0.125, ny = 0.000, nz = 0

        line (ax, ay, az, bx, by, bz, 0xffff00)

        line (bx, by, bz, cx, cy, cz, 0xffff00)
        line (bx, by, bz, fx, fy, fz, 0xffff00)
        line (cx, cy, cz, ix, iy, iz, 0xffff00)
        line (fx, fy, fz, lx, ly, lz, 0xffff00)
        line (ix, iy, iz, lx, ly, lz, 0xffff00)

        line (cx, cy, cz, dx, dy, dz, 0xffff00)
        line (dx, dy, dz, ex, ey, ez, 0xffff00)

        line (fx, fy, fz, gx, gy, gz, 0xffff00)
        line (gx, gy, gz, hx, hy, hz, 0xffff00)

        line (ix, iy, iz, jx, jy, jz, 0xffff00)
        line (jx, jy, jz, kx, ky, kz, 0xffff00)

        line (lx, ly, lz, mx, my, mz, 0xffff00)
        line (mx, my, mz, nx, ny, nz, 0xffff00)

        /* Fill the bounding box with noise. This is gross for now, we'll need
         * some sort of rejection method to only fill the space filled with the
         * character. */
        var minx = Math.min (ax, bx, cx, dx, ex, fx, gx, hx, ix, jx, kx, lx, mx, nx),
            maxx = Math.max (ax, bx, cx, dx, ex, fx, gx, hx, ix, jx, kx, lx, mx, nx),
            miny = Math.min (ay, by, cy, dy, ey, fy, gy, hy, iy, jy, ky, ly, my, ny),
            maxy = Math.max (ay, by, cy, dy, ey, fy, gy, hy, iy, jy, ky, ly, my, ny),
            maxz = Math.max (az, bz, cz, dz, ez, fz, gz, hz, iz, jz, kz, lz, mz, nz),
            minz = Math.min (az, bz, cz, dz, ez, fz, gz, hz, iz, jz, kz, lz, mz, nz),
            i = 8192

        minx -= 0.0625
        maxx += 0.0625
        miny -= 0.0625
        maxy += 0.0625
        minz -= 0.0625
        maxz += 0.0625

        while (i--)
          point (
            minx + (maxx - minx) * Math.random (),
            miny + (maxy - miny) * Math.random (),
            minz + (maxz - minz) * Math.random (),
            Math.random () * 0x1000000 & 0x3f1f7f
          )
      }

      var start = Date.now ()

      reset ()

      setInterval (function () {
        var millis = Date.now () - start,
            t = millis * Math.PI / 8000

        clear ()
        camera (Math.cos (t) * 2, 2.5, Math.sin (t) * 2, 0, 0.5, 0, 0, 1, 0)

        person ()

        apply ()
      }, 1000 / 60)
    </script>
  </body>
</html>
