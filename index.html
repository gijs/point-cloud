<html>
  <head>
  </head>

  <body>
    <canvas id="canvas" width="640" height="360" style="background: black;">
    </canvas>

    <script type="text/javascript" src="matrix.js"></script>

    <script type="text/javascript">
      var canvas = document.getElementById ("canvas"),
          width = canvas.width,
          height = canvas.height,
          ctx = canvas.getContext ("2d"),
          id = ctx.getImageData (0, 0, width, height),
          data = id.data,
          w4 = width << 2,
          w2 = width << 1,
          h4 = height << 2,
          h2 = height << 1,
          r0, r1, r2, r3

      function clear () {
        var i = data.length

        while (i) {
          data[--i] = 0
          i -= 3
        }
      }

      function apply () {
        ctx.putImageData (id, 0, 0)
      }

      function reset () {
        r0 = 0.76758391689509150
        r1 = 0.54703062842600050
        r2 = 0.08701058942824602
        r3 = 1
      }

      function random () {
        var t = 2091639 * r2 + r3 * 2.3283064365386963e-10

        r3 = t | 0
        r2 = r1
        r1 = r0
        return r0 = t - (r3 = t | 0)
      }

      function point (x, y, z, rgb) {
        var m = matrix.length - 8,
            u, v, w

        w = x * matrix[m++] + y * matrix[m++] + z * matrix[m++] + matrix[m++]
        if (w < 1) return

        w = w4 / w
        m -= 12

        u = ((x * matrix[m++] + y * matrix[m++] + z * matrix[m++] + matrix[m++]) * w + w2) & 0x7ffffffc
        if (u > w4) return

        v = ((x * matrix[m++] + y * matrix[m++] + z * matrix[m++] + matrix[m++]) * w + h2) & 0x7ffffffc
        if (v > h4) return

        w = v * width + u + 3

        if (data[w]) {
          data[--w] += rgb & 255
          data[--w] += (rgb >> 8) & 255
          data[--w] += (rgb >> 16) & 255
        }

        else {
          data[  w] = 255
          data[--w] = rgb & 255
          data[--w] = (rgb >> 8) & 255
          data[--w] = (rgb >> 16) & 255
        }
      }

      function star () {
        var x, y, z

        do {
          x = random () - 0.5
          y = random () * -0.5
          z = random () - 0.5
        } while (x * x + y * y + z * z > 0.25)

        point (x * 2048, y * 2048, z * 2048, random () * 0x1000000 & 0xbf7fbf)
      }

      function spiralArm () {
        var d = random () * random (),
            a = (d * d + Math.floor (random () * 5) * 0.4) * Math.PI,
            k = 0.125 / (1 + d),
            x, y, z

        do {
          x = random () - 0.5
          y = random () - 0.5
          z = random () - 0.5
        } while (x * x + y * y + z * z > 0.25)

        point (
          x * k + Math.cos (a) * d, y * k, z * k + Math.sin (a) * d,
          random () * 0x1000000 & (random () > d ? 0x7f3f3f : 0x5f5fef))
      }

      function cloud () {
        var d = 2 * random () * random (),
            x, y, z

        do {
          x = random () - 0.5
          y = random () - 0.5
          z = random () - 0.5
        } while (x * x + y * y + z * z > 0.25)

        point (x * d, y * d * 0.125, z * d, random () * 0x1000000 & 0x6f3f6f)
      }

      var start = Date.now ()

      setInterval (function () {
        var millis = Date.now () - start,
            t = millis * Math.PI / 8000,
            i

        reset ()
        clear ()
        camera (Math.cos (t) * 2, 2, Math.sin (t) * 2, 0, 0, 0, 0, 1, 0)

        i = 2048; while (i--) star ()
        i = 4096; while (i--) spiralArm ()
        i = 8192; while (i--) cloud ()

        apply ()
      }, 1000 / 60)
    </script>
  </body>
</html>
